name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Release Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check
        run: bun run check

      - name: Generate changelog
        run: bunx changelogithub
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update npm
        run: npm install -g npm@latest

      - name: Publish packages to npm
        run: |
          bunx clean-pkg-json
          bun pm pack

          # Determine if this is a prerelease tag (e.g., v1.0.0-beta.1)
          TAG_NAME=${GITHUB_REF#refs/tags/}

          # Define the base publish command
          PUBLISH_CMD="npm publish ./*.tgz --access public"

          # If tag contains a hyphen, it's a prerelease (e.g., -alpha, -beta)
          if [[ $TAG_NAME == *-* ]]; then
            # Extract the word after the hyphen (e.g., 'alpha') to use as the npm tag
            # If no word is found, it defaults to 'next'
            PRERELEASE_TYPE=$(echo $TAG_NAME | sed -E 's/v?[0-9]+\.[0-9]+\.[0-9]+-?([a-zA-Z]+)?.*/\1/')
            DIST_TAG=${PRERELEASE_TYPE:-next}
            
            echo "Prerelease detected ($TAG_NAME). Publishing with --tag $DIST_TAG"
            $PUBLISH_CMD --tag $DIST_TAG
          else
            echo "Stable release detected ($TAG_NAME). Publishing as latest."
            $PUBLISH_CMD
          fi
